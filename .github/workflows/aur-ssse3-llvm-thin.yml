name: Build Godot32 (SSSE3, LLVM, ThinLTO)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Enable multilib and refresh mirrors
        run: |
          set -euxo pipefail
          if ! grep -q '^\[multilib\]' /etc/pacman.conf; then
            cat >> /etc/pacman.conf <<'EOF'
          [multilib]
          Include = /etc/pacman.d/mirrorlist
          EOF
          fi
          pacman-key --init || true
          pacman-key --populate archlinux || true
          pacman -Syu --noconfirm

      - name: Install build & runtime dependencies
        run: |
          set -euxo pipefail

          PKG32=(
            ca-certificates \
            lib32-brotli \
            lib32-freetype2 \
            lib32-libglvnd \
            lib32-libtheora \
            lib32-libvorbis \
            lib32-libwebp \
            lib32-libxcursor \
            lib32-libxi \
            lib32-libxinerama \
            lib32-libxrandr \
            lib32-pcre2 \
            lib32-alsa-lib \
            lib32-pulseaudio \
            lib32-glib2 \
            pulse-native-provider \
            libwslay \
            libsquish \
            graphite \
            openxr \
            miniupnpc \
            cmake \
            meson \
            lib32-vulkan-icd-loader \
            vulkan-headers
          )

          pacman -S --noconfirm --needed base-devel git scons yasm setconf clang lld "${PKG32[@]}"

      - name: Change zstd to use --auto-threads=logical and disable debug in OPTIONS..
        run: |
          sed -i 's/^COMPRESSZST.*/COMPRESSZST=(zstd -c -T0 --auto-threads=logical -)/' /etc/makepkg.conf
          sed -i -e '/^OPTIONS=.*/ s/debug/!debug/' /etc/makepkg.conf

      - name: Create build user and set permissions
        run: |
          set -euxo pipefail
          useradd -m builder || true
          chown -R builder:builder "$GITHUB_WORKSPACE"

      - name: Install AUR dependencies.
        run: |
          cd "$GITHUB_WORKSPACE"

          AUR_DEPS=(
          lib32-libwslay
          lib32-libsquish
          lib32-graphite
          lib32-jsoncpp
          lib32-openxr
          lib32-miniupnpc
          )

          for pkg in ${AUR_DEPS[@]}; do
            su - builder -c "cd $GITHUB_WORKSPACE &&
                            git clone 'https://aur.archlinux.org/${pkg}.git' &&
                            cd ${pkg} &&
                            makepkg --noconfirm --skippgpcheck"

            cd $GITHUB_WORKSPACE/${pkg} &&
            pacman -U --noconfirm ${pkg}*
          done

      - name: Build package as builder and use -18 compression.
        run: |
          set -euxo pipefail

          sed -i 's/^COMPRESSZST.*/COMPRESSZST=(zstd -c -18 -T0 --auto-threads=logical -)/' /etc/makepkg.conf
          cd "$GITHUB_WORKSPACE"

          # Create a temporary script to work around shell quoting.
          cat > patch_commands.sh <<'EOF'
          cd "$GITHUB_WORKSPACE" &&
          git clone 'https://aur.archlinux.org/godot32.git' &&
          cd godot32 &&
          sed -i 's/^\([[:space:]]*\)use_llvm=.*/\1use_llvm=yes/' PKGBUILD &&
          sed -i '/^[[:space:]]*use_llvm=yes$/a\    linker=lld' PKGBUILD &&
          sed -i '/^[[:space:]]*linker=lld$/a\    lto=thin' PKGBUILD &&
          sed -i 's|^\([[:space:]]*\)install -Dm755 bin/.*|\1install -Dm755 bin/godot.linuxbsd.editor.\${_godot_arch}.llvm "\${pkgdir}/usr/bin/godot32"|' PKGBUILD &&
          sed -i "/^[[:space:]]*# Patch for miniupnpc/ i\    sed -i '/^[[:space:]]*env.Append(CCFLAGS=[\"-msse2\".*/ s/-msse2/-mssse3/' SConstruct" PKGBUILD &&
          sed -i "/env.Append/ s|CCFLAGS=\[|CCFLAGS=\\\[|" PKGBUILD &&
          makepkg --noconfirm
          EOF

          chmod +x patch_commands.sh

          # Run as builder
          su builder -c "$GITHUB_WORKSPACE/patch_commands.sh"

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: godot32-ssse3-llvm-thin
          path: "${{github.workspace}}/godot32/*.pkg.tar.zst"
